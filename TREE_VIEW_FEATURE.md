# Tree View Feature Documentation

## Overview

Добавлен новый режим отображения данных - **Tree View**, который решает проблему горизонтального скролла на мобильных устройствах и предоставляет более удобный способ редактирования данных.

## Архитектура

### Компоненты

1. **TreeEditableTable** (`src/components/TreeEditableTable.tsx`)
   - Основной компонент для отображения данных в виде дерева
   - Группирует поля по категориям: "Основная информация" и "Финансы"
   - Поддерживает все операции: добавление, удаление, сохранение

2. **EditSidePanel** (`src/components/EditSidePanel.tsx`)
   - Боковая панель для редактирования полей выбранной строки
   - Автоматический пересчет связанных полей (Qty, Price, Net, VAT, Total)
   - Адаптивный дизайн для мобильных и десктопных устройств

3. **EditPageContent** (`src/app/edit/EditPageContent.tsx`)
   - Добавлен переключатель режимов (Table/Tree)
   - Условный рендеринг компонентов в зависимости от выбранного режима

### Структура дерева

```
Row #1 (Item name)
├─ Основная информация
│   ├─ Qty: [value]
│   ├─ Unit: [value]
│   ├─ Art: [value]
│   └─ Item: [value]
└─ Финансы
    ├─ Price: [value]
    ├─ Net: [value]
    ├─ VAT: [value]
    └─ Total: [value]
```

## Использование

### Переключение режимов

В верхней части страницы редактирования есть кнопки переключения:
- **Table** - классический табличный вид с горизонтальным скроллом
- **Tree** - новый древовидный вид без горизонтального скролла

### Редактирование в Tree View

1. Кликните на строку в дереве
2. Откроется боковая панель с формой редактирования
3. Измените нужные поля
4. Нажмите "Save Changes" для сохранения или "Cancel" для отмены

### Операции

- **Add Row** - добавляет новую строку с дефолтными значениями
- **Delete Selected** - удаляет выбранные строки (пока не реализовано в Tree View)
- **Save & Send Back** - сохраняет изменения и отправляет данные обратно в бот

## Преимущества Tree View

✅ **Нет горизонтального скролла** - все данные помещаются на экране мобильного устройства
✅ **Логическая группировка** - поля сгруппированы по смыслу (основная информация и финансы)
✅ **Удобное редактирование** - боковая панель с большими полями ввода
✅ **Автоматический пересчет** - изменение Qty, Price, Net, VAT или Total автоматически пересчитывает связанные поля
✅ **Адаптивный дизайн** - работает на мобильных и десктопных устройствах

## Технические детали

### Зависимости

- `shadcn-tree-view` - компонент дерева
- `@radix-ui/react-dialog` - для боковой панели (Sheet)
- `lucide-react` - иконки

### Установка

```bash
npx shadcn add "https://mrlightful.com/registry/tree-view"
npx shadcn add sheet
```

### API

#### TreeEditableTable Props

```typescript
interface TreeEditableTableProps {
  data: ReceiptData
  onDataChange?: (data: ReceiptData) => void
  loading?: boolean
}
```

#### EditSidePanel Props

```typescript
interface EditSidePanelProps {
  isOpen: boolean
  onClose: () => void
  rowData: ReceiptItem | null
  rowIndex: number | null
  onSave: (rowIndex: number, updatedRow: ReceiptItem) => void
}
```

## Тестирование

### Локальное тестирование

1. Запустите dev сервер:
   ```bash
   npm run dev:3004
   ```

2. Создайте тестовую сессию:
   ```bash
   curl -X POST http://localhost:3004/api/session \
     -H "Content-Type: application/json" \
     -d '{
       "session_id": "550e8400-e29b-41d4-a716-446655440000",
       "data": [
         {"#": 1, "Qty": 2, "Unit": "pcs", "Art": "LAP001", "Item": "Laptop", "Price": 1000, "Net": 2000, "VAT": 400, "Total": 2400}
       ]
     }'
   ```

3. Откройте в браузере:
   ```
   http://localhost:3004/edit?session_id=550e8400-e29b-41d4-a716-446655440000
   ```

4. Переключитесь в режим Tree и протестируйте функционал

## Будущие улучшения

- [ ] Добавить поддержку выбора строк в Tree View (checkboxes)
- [ ] Добавить drag & drop для изменения порядка строк
- [ ] Добавить поиск/фильтрацию в Tree View
- [ ] Добавить возможность сворачивать/разворачивать все узлы одной кнопкой
- [ ] Добавить unit и E2E тесты для Tree View

## Известные ограничения

- Сортировка работает только в Table View
- Выбор нескольких строк для удаления пока не реализован в Tree View
- При добавлении новой строки панель редактирования не открывается автоматически

## Совместимость

- ✅ Chrome/Edge (последние версии)
- ✅ Safari (последние версии)
- ✅ Firefox (последние версии)
- ✅ Mobile Safari (iOS 14+)
- ✅ Chrome Mobile (Android 10+)
